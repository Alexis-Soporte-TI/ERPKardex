<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="mb-3">
                <label for="cbx_Modelo_MarcaId" class="font-weight-bold">Marca Relacionada</label>
                <select id="cbx_Modelo_MarcaId" class="form-control">
                    <option value="">-- SELECCIONAR MARCA --</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="txt_ModeloNombre" class="font-weight-bold">Nombre del Modelo</label>
                <input type="text" id="txt_ModeloNombre" class="form-control" placeholder="Ej: Premium X1" oninput="this.value = this.value.toUpperCase();">
            </div>
            <div class="mb-3">
                <label for="cbx_ModeloEstado" class="font-weight-bold">Estado</label>
                <select id="cbx_ModeloEstado" class="form-control">
                    <option value="1">ACTIVO</option>
                    <option value="0">INACTIVO</option>
                </select>
            </div>
            <div class="text-center mt-4">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Cancelar</button>
                <button id="btn_GuardarModelo" type="button" class="btn btn-primary">Registrar</button>
            </div>
        </div>
    </div>
</div>
<script>
        $(document).ready(function () {
        // 1. Llenar el combo de marcas dentro del modal
        fct_FillCombo('/Producto/GetMarcaData', '#cbx_Modelo_MarcaId', 'id', 'nombre', '-- SELECCIONAR MARCA --');

        // 2. Pre-seleccionar la marca que ya esté elegida en el formulario principal
        let marcaPadre = $('#cbx_Marca').val();
        if (marcaPadre) {
            // Delay para asegurar que el combo terminó de cargar los datos
            setTimeout(() => {
                $('#cbx_Modelo_MarcaId').val(marcaPadre);
            }, 500);
        }
    });

    $(document).off('click', '#btn_GuardarModelo').on('click', '#btn_GuardarModelo', function () {
        // 1. Recolección de datos
        let marcaId = $("#cbx_Modelo_MarcaId").val();
        let nombre = $("#txt_ModeloNombre").val().trim();
        let estado = $("#cbx_ModeloEstado").val();

        // 2. Validaciones
        if (!marcaId || !nombre) {
            toastr.warning("Debe seleccionar una marca e ingresar el nombre del modelo", "MENSAJE DE SISTEMA");
            return;
        }

        // 3. Confirmación
        Swal.fire({
            title: "¿Registrar Modelo?",
            text: `Se registrará el modelo: ${nombre}`,
            icon: "question",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Sí, registrar",
            cancelButtonText: "Cancelar",
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {

                // 4. Objeto para el controlador
                let pModelo = {
                    MarcaId: Number(marcaId),
                    Nombre: nombre,
                    Estado: estado === "1"
                };

                $.ajax({
                    url: "/Producto/RegistrarModelo",
                    type: "POST",
                    data: pModelo,
                    success: function (response) {
                        if (response.status === true) {
                            toastr.success(response.message, "MENSAJE DE SISTEMA");

                            // 5. Refrescar el combo en el Index filtrado por la marca actual
                            let marcaActualIndex = $('#cbx_Marca').val();
                            if (marcaActualIndex) {
                                fct_FillCombo('/Producto/GetModelosByMarca?marcaId=' + marcaActualIndex, '#cbx_Modelo', 'id', 'nombre', '-- SELECCIONAR MODELO --');
                            }

                            // 6. Cerrar el modal
                            $("#dynamic-modal").modal('hide');
                        } else {
                            toastr.warning(response.message, 'MENSAJE DE SISTEMA');
                        }
                    },
                    error: function (xhr) {
                        toastr.error("Error al registrar el modelo", "MENSAJE DE SISTEMA");
                    }
                });
            }
        });
    });
</script>